{% extends "search_results_base.html" %}

{% set endpoint = 'topics:search' %}

{% macro show_results(results) %}
    {% for hit in results %}
        {{ res_cnt_inc() }}
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title pull-left col-sm-2 nofloat">
                    <a href="{{ url_for('topic', name=hit['t']) }}">
                        Topic #{{ hit['t'] }}
                    </a>
                </h3>

                <div class="progress col-sm-10 nofloat">
                    <div class="progress-bar progress-bar-default" style="width: {{ hit['p'] / 0.036708 * 100 }}%">
                        <span>
                            P(t) = {{ hit['p'] | round(3) }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="panel-body">
                <div class="bs-callout bs-callout-info">
                    {% set docs = vector_data(hit, 'docslugs') %}
                    <h4 class="progress-label">Documents:</h4>

                    <ul class="tagcloud">
                        {% for d in docs[:15] %}
                            <li>
                                <a href="{{ url_for('document', name=d.d) }}" title="P(t | d) = {{ d.np | round(3) }}" data-size="{{ d.np }}">{{ d.d }}</a>
                            </li>
                        {% endfor %}

                        {% if vector_length(hit, 'docslugs') > 15 %}
                            <li>&hellip;&nbsp;{{ vector_length(hit, 'docslugs') - 15 }}&nbsp;more&nbsp;&hellip;</li>
                        {% endif %}
                    </ul>
                </div>

                <div class="bs-callout bs-callout-info">
                    {% set docs = vector_data(hit, 'docauthors') %}
                    <h4 class="progress-label">Authors:</h4>

                    <ul class="tagcloud">
                        {% for d in docs[:15] %}
                            <li>
                                <a href="{{ url_for('document', name=d.d) }}" title="Score = {{ d.np | round(3) }}" data-size="{{ d.np }}">{{ d.w }}</a>
                            </li>
                        {% endfor %}

                        {% if vector_length(hit, 'docauthors') > 15 %}
                            <li>&hellip;&nbsp;{{ vector_length(hit, 'docauthors') - 15 }}&nbsp;more&nbsp;&hellip;</li>
                        {% endif %}
                    </ul>
                </div>

                <div class="bs-callout bs-callout-info">
                    {% set words = vector_data(hit, 'words') %}
                    <h4 class="progress-label">Words:</h4>

                    <ul class="tagcloud">
                        {% for w in words[:30] %}
                            <li>
                                <a href="{{ url_for('word', name=w.w) }}" title="P(w | t) = {{ w.np | round(3) }}" data-size="{{ w.np }}">{{ w.w }}</a>
                            </li>
                        {% endfor %}

                        {% if vector_length(hit, 'words') > 30 %}
                            <li>&hellip;&nbsp;{{ vector_length(hit, 'words') - 30 }}&nbsp;more&nbsp;&hellip;</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    {% endfor %}
{% endmacro %}

{% block body %}
    {% set pmax = (topics | max(attribute=['np', 0]), topics | max(attribute=['np', 1])) %}

    {% if pmax[0] and pmax|sum > 0 %}
        <h2>Distribution overview:</h2>
        <div id="plot-topics-docs" style="height:400px;"></div>
        {% if pmax[1] > 0 %}
            <div id="plot-topics-words" style="height:400px;"></div>
        {% endif %}

        <script type="text/javascript">
            $(function () {
                createPieChart(
                    $('#plot-topics-docs'),
                    'P({{ 't' if not query else 't | document matches query' }})',
                    ['t', 'P'],
                    [
                        {% for t in topics | sort(attribute='np', reverse=True) if t.np|sum > 0 %}
                            {
                                name: '{{ t.t }}',
                                y: {{ t.np[0] | round(3) }},
                                url: '{{ url_for('topic', name=t.t) }}'
                            },
                        {% endfor %}
                    ]
                );
            });

            {% if pmax[1] > 0 %}
                $(function () {
                    createPieChart(
                        $('#plot-topics-words'),
                        'P(word matches query | t)',
                        ['t', 'P'],
                        [
                            {% for t in topics | sort(attribute='np', reverse=True) if t.np|sum > 0 %}
                                {
                                    name: '{{ t.t }}',
                                    y: {{ t.np[1] | round(5) }},
                                    url: '{{ url_for('topic', name=t.t) }}'
                                },
                            {% endfor %}
                        ]
                    );
                });
            {% endif %}
        </script>

        <h2>Topics matched:</h2>
        {% for t in topics | sort(attribute='np', reverse=True) if t.np|sum > 0 %}
            {{ res_cnt_inc() }}
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title pull-left col-sm-2 nofloat">
                        <a href="{{ url_for('topic', name=t.t) }}">
                            Topic #{{ t.t }}
                        </a>
                    </h3>

                    <div class="nofloat">
                        <div class="progress col-sm-10 nofloat">
                            <div class="progress-bar progress-bar-default" style="width: {{ t.np[0]/pmax[0] * 100 }}%">
                                <span>
                                    P({{ 't' if not query else 't | document matches query' }}) = {{ t.np[0] | round(3) }}
                                </span>
                            </div>
                        </div>

                        {% if pmax[1] > 0 %}
                            <div class="progress col-sm-10 nofloat">
                                <div class="progress-bar progress-bar-success" style="width: {{ t.np[1]/pmax[1] * 100 }}%">
                                    <span>
                                        P(word matches query | t) = {{ t.np[1] | round(5) }}
                                    </span>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="panel-body">
                    <div class="bs-callout bs-callout-info">
                        <h4 class="progress-label">
                            Documents<br/>
                            <small>Matched only</small>
                        </h4>

                        <ul class="tagcloud">
                            {% for d in t.documents[:30] %}
                                <li>
                                    <a href="{{ url_for('document', name=d.d) }}" data-size="{{ d['gr_weights'][t.t] }}"
                                    data-placement="top" data-toggle="tooltip" data-html="true"
                                    title="
                                    {{ highlight(d, 'whole', ['title', 'title_ngrams'], 'title').replace('"', "'") | safe }}<br/><br/>
                                    {{ highlight(d, 'whole', ['authors', 'authors_ngrams'], 'authors').replace('"', "'") | safe }}<hr/>
                                    P(t | d) = {{ d['gr_weights'][t.t] | round(3) }}
                                    ">{{ d['slug'] }}</a>
                                </li>
                            {% else %}
                                <li>Nothing matched</li>
                            {% endfor %}

                            {% if t.documents|length > 30 %}
                                <li>&hellip;&nbsp;{{ t.documents|length - 30 }}&nbsp;more&nbsp;&hellip;</li>
                            {% endif %}
                        </ul>
                    </div>

                    <div class="bs-callout bs-callout-info">
                        <h4 class="progress-label">
                            Words<br/>
                            <small>{{ 'Matched only' if request.args['words_search'] else 'All related' }}</small>
                        </h4>

                        <ul class="tagcloud">
                            {% for w in t.words[:30] %}
                                <li>
                                    <a href="{{ url_for('word', name=w.w) }}" title="P(w | t) = {{ w.np | round(3) }}" data-size="{{ w.np }}">{{ w.word | safe }}</a>
                                </li>
                            {% else %}
                                <li>Nothing matched</li>
                            {% endfor %}

                            {% if t.words|length > 30 %}
                                <li>&hellip;&nbsp;{{ t.words|length - 30 }}&nbsp;more&nbsp;&hellip;</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}
{% endblock %}
