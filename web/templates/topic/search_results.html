{% extends "search_results_base.html" %}
{% import "macros.html" as macros %}

{% set endpoint = 'topics:search' %}

{% block body %}
    {% set pmax = (topics | max(attribute=['np', 0]), topics | max(attribute=['np', 1])) %}

    {% if topics and pmax|sum > 0 %}
        <h2>Distribution overview</h2>

        {% if pmax[0] > 0 %}
            <div id="plot-topics-docs" style="height:250px;"></div>
            <script type="text/javascript">
                $(function () {
                    createPieChart(
                        $('#plot-topics-docs'),
                        'P({{ 't' if not query else 't | document matches query' }})',
                        ['t', 'P'],
                        [
                            {% for t in topics | sort(attribute='np', reverse=True) if t.np|sum > 0 %}
                                {
                                    name: '{{ t.t }}',
                                    y: {{ t.np[0] | round(3) }},
                                    url: '{{ url_for('topic', name=t.t) }}'
                                },
                            {% endfor %}
                        ],
                        undefined, true
                    );
                });
            </script>
        {% endif %}

        {% if pmax[1] > 0 %}
            <div id="plot-topics-words" style="height:250px;"></div>
            <script type="text/javascript">
                {% if pmax[1] > 0 %}
                    $(function () {
                        createPieChart(
                            $('#plot-topics-words'),
                            'P(word matches query | t)',
                            ['t', 'P'],
                            [
                                {% for t in topics | sort(attribute='np', reverse=True) if t.np|sum > 0 %}
                                    {
                                        name: '{{ t.t }}',
                                        y: {{ t.np[1] | round(5) }},
                                        url: '{{ url_for('topic', name=t.t) }}'
                                    },
                                {% endfor %}
                            ]
                        );
                    });
                {% endif %}
            </script>
        {% endif %}


        <h2>{{ 'Matched' if query else 'Top' }} topics</h2>
        {% for t in topics | sort(attribute='np', reverse=True) if t.np|sum > 0 %}
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title pull-left col-sm-2 nofloat">
                        <a href="{{ url_for('topic', name=t.t) }}">
                            Topic #{{ t.t }}
                        </a>
                    </h3>

                    <div class="nofloat">
                        {% if pmax[0] > 0 %}
                            <div class="progress col-sm-10 nofloat">
                                <div class="progress-bar progress-bar-default" style="width: {{ t.np[0]/pmax[0] * 100 }}%">
                                    <span>
                                        P({{ 't' if not query else 't | document matches query' }}) = {{ t.np[0] | round(3) }}
                                    </span>
                                </div>
                            </div>
                        {% endif %}

                        {% if pmax[1] > 0 %}
                            <div class="progress col-sm-10 nofloat">
                                <div class="progress-bar progress-bar-success" style="width: {{ t.np[1]/pmax[1] * 100 }}%">
                                    <span>
                                        P(word matches query | t) = {{ t.np[1] | round(5) }}
                                    </span>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="panel-body">
                    <div class="bs-callout bs-callout-{{ macros.colcl('docs') }}">
                        <h4 class="block-label">
                            Documents<br/>
                            <small>Matched only</small>
                        </h4>

                        {% call(d) macros.tagcloud(t.documents, 20, 'Nothing matched') %}
                            {{ macros.document_in_tagcloud(d['slug'], d['gr_weights'][t.t], 'P(t | d) = %.3f', highlight(d, 'whole', ['title', 'title_ngrams'], 'title').replace('"', "'") | safe, highlight(d, 'whole', ['authors', 'authors_ngrams'], 'authors').replace('"', "'") | safe) }}
                        {% endcall %}
                    </div>

                    <div class="bs-callout bs-callout-{{ macros.colcl('words') }}">
                        <h4 class="block-label">
                            Words<br/>
                            <small>{{ 'Matched only' if request.args['words_search'] else 'All related' }}</small>
                        </h4>

                        {% call(w) macros.tagcloud(t.words, 30, 'Nothing matched') %}
                            <a href="{{ url_for('word', name=w.w) }}" title="P(w | t) = {{ w.np | round(3) }}" data-size="{{ w.np }}" data-use-size="true">{{ w.word | safe }}</a>
                        {% endcall %}
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}
{% endblock %}
