{% import "macros.html" as macros %}

{% if present_as == 'topics' %}
    {% for t in results[1].children recursive %}
        {% set topic = t.child %}

        <div class="panel panel-default col-xs-offset-{{ topic.level - 1 }}">
            <div class="panel-heading">
                <h3 class="panel-title">
                    <a href="{{ url_for('topic', id=topic.id) }}">
                        Topic {{ topic.text }}
                    </a>
                </h3>

                <div class="nofloat">
                    <div class="progress small" title="P({{ 't' if not query else 't | document matches query' }}) = {{ topic.probability | round(3) }}">
                        <div class="progress-bar progress-bar-default" style="width: {{ topic.probability * 100 }}%"></div>
                    </div>
                </div>
            </div>

            <div class="panel-body">
                <div class="bs-callout bs-callout-{{ macros.colcl('docs') }}">
                    <h4 class="block-label">
                        Documents<br/>
                        <small>{{ 'Matched only' if query }}</small>
                    </h4>

                    {% call(d) macros.tagcloud(topic.documents, limit=-1, emptystr='Nothing matched', additional_class='collapsed collapsed-small') %}
                        {{ macros.document_in_tagcloud(d.document.file_name, d.probability, 'P(t | d) = %.3f', d.document.title | safe, '') }}
                    {% endcall %}
                </div>

                <div class="bs-callout bs-callout-{{ macros.colcl('words') }}">
                    <h4 class="block-label">
                        Words<br/>
                        <small>{{ 'Matched only' if request.args['words_search'] }}</small>
                    </h4>

                    {% call(w) macros.tagcloud(topic.terms, limit=-1, emptystr='Nothing matched', additional_class='collapsed collapsed-small') %}
                        <a href="{{ url_for('word', text=w.term.text) }}" title="P(w | t) = {{ w.probability | round(3) }}" data-size="{{ w.probability }}" data-use-size="true">{{ w.term.text | safe }}</a>
                    {% endcall %}
                </div>
            </div>
        </div>

        {{ loop(topic.children) }}
    {% endfor %}
{% else %}
    {% for doc in results %}
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">
                    <a href="{{ url_for('document', name=doc.file_name) }}">
                        {{ doc.title_hl | safe }}
                    </a>
                </h3>
                <div>
                    <span>
                        {% for term in doc.modality(name='authors').terms %}
                            <a href="{#{{ url_for('documents:search', query='authors:"%s"' % doc.meta['authors']) }}#}">
                                {{ term.term.text -}}
                            </a>
                            {{- ',' if not loop.last }}
                        {% endfor %}
                    </span>
                    |
                    <a href="{{ url_for('browse', query='conference:%s AND year:%s AND %s' % (doc['conference'], doc['year'], query), **request.args) }}">
                        {{ doc.conference }}
                    </a>
                </div>
            </div>

            <div class="panel-body">
                <div class="bs-callout bs-callout-{{ macros.colcl('topics') }}">
                    {% set topics = doc.topics %}
                    <h4 class="block-label">Topics:</h4>

                    <div class="pull-left sparkline" data-type="column" data-xvals='{{ topics | join(',', 'topic.text') }}' data-yvals="{{ topics | join(',', 'probability') }}" data-titles="t,p" data-hlite-tag="true"></div>

                    {% call(t) macros.tagcloud(topics) %}
                        <a href="{{ url_for('topic', id=t.topic.id) }}" title="P(t | d) = {{ t.probability | round(3) }}" data-size="{{ t.probability }}" data-use-size="true">{{ t.topic.text }}</a>
                    {% endcall %}
                </div>

                {#{% set content_hl = hcontent(doc) %}
                {% if content_hl %}
                    <div class="bs-callout bs-callout-{{ macros.colcl('other') }}">
                        {{ content_hl.strip().replace('\n', '<br/>') | safe }}
                    </div>
                {% endif %}#}
            </div>
        </div>
    {% endfor %}
    {% if results_cnt > results|length %}
        <div class="text-center panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">
                    ... {{ results_cnt - results|length }} documents more ...
                </h3>
            </div>
        </div>
    {% endif %}
{% endif %}
