<div class="well well-sm">
    Showing <samp id="search-count"></samp> of <samp>{{ results_cnt }}</samp> results.
</div>

{% if grouped %}
    {% for gr_name, gr_hits in grouped %}
        <div>
            <div class="bs-callout bs-callout-right bs-callout-default bg-success">
                <h4 class="text-right">{{ gr_name }}</h4>
            </div>

            {% for hit in gr_hits[:3] %}
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            <a href="{{ url_for('document', slug=hit['slug']) }}">
                                {{ hl_whole(hit, 'title')|safe or hl_whole(hit, 'title_ngrams', hit['title'])|safe or hit['title'] }}
                            </a>
                        </h3>
                        <div>
                            {{ hl_whole(hit, 'authors')|safe or hl_whole(hit, 'authors_ngrams', hit['authors'])|safe or hit['authors'] }}
                        </div>
                        <div>
                            {{ hit['conference'] }},&nbsp;{{ hit['year'] }}
                        </div>
                    </div>

                    <div class="panel-body">
                        <h4 class="progress-label">Topics:</h4>
                        <div class="progress">
                            {% set topics = htopics(hit) %}
                            {% for t in topics[:5] %}
                                <div class="progress-bar progress-bar-{{ loop.cycle('default', 'info', 'success', 'warning', 'danger') }}" style="width: {{ t.np * 100 }}%"
                                data-placement="top" data-toggle="tooltip" data-html="true"
                                title="<h4>Topic #{{ t.t }}</h4>P(t | d) = {{ t.np | round(3) }}"></div>
                            {% endfor %}
                            {% if topics | length > 5 %}
                                <div class="progress-bar progress-bar-transparent" style="width: {{ topics[5:] | sum('np') * 100 }}%"
                                data-placement="top" data-toggle="tooltip" data-html="true"
                                title="<h4>Topics #{{ topics[5:] | join(', #', attribute='t') }}</h4>Total P(t | d) = {{ topics[5:] | sum('np') | round(3) }}"></div>
                            {% endif %}
                        </div>

                        {% if request.args.get('in_text', False) == 'true' %}
                            <div class="bs-callout bs-callout-info">
                                {{ hl_content(hit)|safe }}
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
            {% if gr_hits|length > 3 %}
                <div class="bs-callout bs-callout-default bg-info">
                    {{ gr_hits|length - 3 }} more results from this group are not shown
                </div>
            {% endif %}
        </div>
    {% endfor %}
{% else %}
    <div>
        {% for hit in results %}
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a href="{{ url_for('document', slug=hit['slug']) }}">
                            {{ hl_whole(hit, 'title')|safe or hl_whole(hit, 'title_ngrams', hit['title'])|safe or hit['title'] }}
                        </a>
                    </h3>
                    <div>
                        {{ hl_whole(hit, 'authors')|safe or hl_whole(hit, 'authors_ngrams', hit['authors'])|safe or hit['authors'] }}
                    </div>
                    <div>
                        {{ hit['conference'] }},&nbsp;{{ hit['year'] }}
                    </div>
                </div>

                <div class="panel-body">
                    <h4 class="progress-label">Topics:</h4>
                    <div class="progress">
                        {% set topics = htopics(hit) %}
                        {% for t in topics[:5] %}
                            <div class="progress-bar progress-bar-{{ loop.cycle('default', 'info', 'success', 'warning', 'danger') }}" style="width: {{ t.np * 100 }}%"
                            data-placement="top" data-toggle="tooltip" data-html="true"
                            title="<h4>Topic #{{ t.t }}</h4>P(t | d) = {{ t.np | round(3) }}"></div>
                        {% endfor %}
                        {% if topics | length > 5 %}
                            <div class="progress-bar progress-bar-transparent" style="width: {{ topics[5:] | sum('np') * 100 }}%"
                            data-placement="top" data-toggle="tooltip" data-html="true"
                            title="<h4>Topics #{{ topics[5:] | join(', #', attribute='t') }}</h4>Total P(t | d) = {{ topics[5:] | sum('np') | round(3) }}"></div>
                        {% endif %}
                    </div>

                    {% if request.args.get('in_text', False) == 'true' %}
                        <div class="bs-callout bs-callout-info">
                            {{ hl_content(hit)|safe }}
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}
