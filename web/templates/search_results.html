<div class="well well-sm">
    Showing <samp id="search-count"></samp> of <samp>{{ results_cnt }}</samp> results.
</div>

{% if corrected %}
    <div class="well well-lg">
        Did you mean <a href="{{ url_for('search', query=corrected.string, **request.args) }}">{{ corrected.html|safe }}</a>?
    </div>
{% endif %}

{% macro show_results(results) %}
    {% for hit in results %}
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">
                    <a href="{{ url_for('document', slug=hit['slug']) }}">
                        {{ hl_whole(hit, 'title')|safe or hl_whole(hit, 'title_ngrams', hit['title'])|safe or hit['title'] }}
                    </a>
                </h3>
                <div>
                    <a href="{{ url_for('search', query='authors:"%s" AND %s' % (hit['authors'], query), **request.args) }}">
                        {{ hl_whole(hit, 'authors')|safe or hl_whole(hit, 'authors_ngrams', hit['authors'])|safe or hit['authors'] }}
                    </a>
                </div>
                <div>
                    <a href="{{ url_for('search', query='conference:%s AND year:%s AND %s' % (hit['conference'], hit['year'], query), **request.args) }}">
                        {{ hit['conference'] }},&nbsp;{{ hit['year'] }}
                    </a>
                </div>
            </div>

            <div class="panel-body">
                <div class="bs-callout bs-callout-info">
                    {% set topics = htopics(hit) %}
                    <h4 class="progress-label">Topics:</h4>
                    <div class="progress">
                        {% for t in topics[:5] %}
                            <a href="{{ url_for('topic', t=t.t) }}">
                            <div class="progress-bar progress-bar-{{ loop.cycle('default', 'info', 'success', 'warning', 'danger') }}" style="width: {{ t.np * 100 }}%"
                            data-placement="top" data-toggle="tooltip" data-html="true"
                            title="<h4>Topic #{{ t.t }}</h4>P(t | d) = {{ t.np | round(3) }}">
                            </div>
                            </a>
                        {% endfor %}
                        {% if topics | length > 5 %}
                            <div class="progress-bar progress-bar-transparent" style="width: {{ topics[5:] | sum('np') * 100 }}%"
                            data-placement="top" data-toggle="tooltip" data-html="true"
                            title="<h4>Topics #{{ topics[5:] | join(', #', attribute='t') }}</h4>Total P(t | d) = {{ topics[5:] | sum('np') | round(3) }}"></div>
                        {% endif %}
                    </div>

                    <ul class="tagcloud">
                        {% for t in topics %}
                            <li>
                                <a href="{{ url_for('topic', t=t.t) }}" title="P(t | d) = {{ t.np | round(3) }}" data-size="{{ t.np }}">{{ t.t }}</a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                {% set content_hl = hl_content(hit)|safe %}
                {% if content_hl %}
                    <div class="bs-callout bs-callout-info">
                        {{ content_hl.strip().replace('\n', '<br/>'|safe) }}
                    </div>
                {% endif %}
            </div>
        </div>
    {% endfor %}
{% endmacro %}

{% if grouped %}
    {% for gr_name, gr_hits in grouped[:30] %}
        <div>
            <div class="bs-callout bs-callout-right bs-callout-default bg-success">
                <h4 class="text-right">{{ gr_name }}</h4>
            </div>

            {{ show_results(gr_hits[:3]) }}

            {% if gr_hits|length > 3 %}
                <div class="bs-callout bs-callout-default bg-info">
                    {{ gr_hits|length - 3 }} more results from this group are not shown
                </div>
            {% endif %}
        </div>
    {% endfor %}
    {% if grouped|length > 30 %}
        <div class="bs-callout bs-callout-default bg-info">
            {{ grouped|length - 30 }} more groups are not shown
        </div>
    {% endif %}
{% else %}
    <div>
        {{ show_results(results) }}
    </div>
{% endif %}
